<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body { padding: 20px; font-family: prompt, sans-serif; }
      .card { margin-bottom: 10px; }
      
      /* กำหนดสีสถานะ */
      .btn-pending { background-color: #ffc107; color: black; border: none; }
      .btn-done { background-color: #198754; color: white; border: none; }
      .btn-loading { opacity: 0.6; cursor: not-allowed; }
    </style>
  </head>
  <body>

    <div class="container">
      <h3>ระบบจัดการงาน (Demo)</h3>
      <div id="data-container">กำลังโหลดข้อมูล...</div>
    </div>

    <script>
      // โหลดข้อมูลเมื่อเปิดเว็บ
      window.onload = function() {
        google.script.run.withSuccessHandler(showData).getData();
      };

      function showData(dataArray) {
        var html = '';
        // ลูปสร้างรายการ (สมมติ dataArray[0] คือ header)
        // สมมติ Column 0 = ID, Column 1 = Name, Column 2 = Status
        
        // *หมายเหตุ: ในการใช้งานจริง ควรใช้การ map ชื่อ column เหมือนฝั่ง Server 
        // แต่ออันนี้ทำแบบง่ายให้เห็นภาพก่อน
        
        for (var i = 1; i < dataArray.length; i++) {
          var row = dataArray[i];
          var id = row[0]; 
          var name = row[1];
          var status = row[2];

          // กำหนด Class สีปุ่มตามสถานะเริ่มต้น
          var btnClass = (status === 'Done') ? 'btn-done' : 'btn-pending';
          var btnText = (status === 'Done') ? 'เรียบร้อย' : 'รอดำเนินการ';

          html += `
            <div class="card p-3">
              <div class="d-flex justify-content-between align-items-center">
                <span><strong>${id}</strong> : ${name}</span>
                
                <button id="btn-${id}" 
                        class="btn ${btnClass}" 
                        onclick="handleClick('${id}', this)">
                  ${btnText}
                </button>
              </div>
            </div>
          `;
        }
        document.getElementById('data-container').innerHTML = html;
      }

      // --- ฟังก์ชันกดปุ่ม (พระเอกฝั่ง Client) ---
      function handleClick(id, btnElement) {
        // ตรวจสอบสถานะปัจจุบันจากข้อความปุ่ม หรือ class
        var currentStatus = btnElement.innerText;
        var newStatus = '';
        
        // สลับสถานะ (Toggle)
        if (currentStatus === 'เรียบร้อย') {
          newStatus = 'Pending';
          // 1. เปลี่ยน UI ทันที (Optimistic UI)
          btnElement.className = 'btn btn-pending';
          btnElement.innerText = 'รอดำเนินการ';
        } else {
          newStatus = 'Done';
          // 1. เปลี่ยน UI ทันที (Optimistic UI)
          btnElement.className = 'btn btn-done';
          btnElement.innerText = 'เรียบร้อย';
        }

        // 2. ส่งข้อมูลไป Server (ทำเบื้องหลัง)
        google.script.run
          .withSuccessHandler(function(res) {
             console.log("บันทึกสำเร็จ: " + res);
             // ไม่ต้องทำอะไรกับปุ่มแล้ว เพราะเปลี่ยนไปแล้ว
          })
          .withFailureHandler(function(err) {
             // 3. ถ้าพัง! ต้องเปลี่ยนกลับ และแจ้งเตือน
             alert("บันทึกไม่สำเร็จ! กรุณาลองใหม่");
             console.error(err);
             
             // Revert UI กลับสู่สภาพเดิม
             if (newStatus === 'Done') {
                btnElement.className = 'btn btn-pending';
                btnElement.innerText = 'รอดำเนินการ';
             } else {
                btnElement.className = 'btn btn-done';
                btnElement.innerText = 'เรียบร้อย';
             }
          })
          .updateStatus(id, newStatus); // เรียกฟังก์ชันใน Code.gs
      }
    </script>
  </body>
</html>
