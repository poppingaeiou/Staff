// *************************************************************
//  API SERVICE V.54 (Single Day - Speed Focus)
// *************************************************************

var SHEET_URL = "https://docs.google.com/spreadsheets/d/1pBPcW_GF43LxGBo_2EoBsPzJV1udACByG0M86IzrA3A/edit";
var CACHE_TIME = 300; // จำข้อมูล 5 นาที

function doGet(e) {
  var requestDate = e.parameter.date || "today"; 
  var cacheKey = "queue_data_" + requestDate;
  var cache = CacheService.getScriptCache();
  
  // 1. ดึงจาก Server Cache (เร็วมาก)
  var cached = cache.get(cacheKey);
  if (cached != null) {
    return ContentService.createTextOutput(cached).setMimeType(ContentService.MimeType.JSON);
  }

  // 2. ถ้าไม่มีใน Cache ให้ไปอ่าน Sheet
  var data = getAppointmentData(requestDate);
  var jsonStr = JSON.stringify(data);
  
  // 3. จำใส่ Cache ไว้
  if (data.status === "success") { 
    cache.put(cacheKey, jsonStr, CACHE_TIME); 
  }
  
  return ContentService.createTextOutput(jsonStr).setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  try {
    var params = JSON.parse(e.postData.contents);
    var targetDate = params.date;
    var row = parseInt(params.row);
    var col = parseInt(params.col);
    var mode = params.mode || 'status'; 

    var ss = SpreadsheetApp.openByUrl(SHEET_URL);
    var sheet = ss.getSheetByName(targetDate);
    
    if (!sheet) return responseJSON({status: 'error', message: 'Sheet not found'});

    if (mode === 'edit_data') {
      var val1 = params.val1 || ""; var val2 = params.val2 || ""; 
      var val3 = params.val3 || ""; var val4 = params.val4 || ""; 
      sheet.getRange(row, col).setValue(val1);     
      sheet.getRange(row + 1, col).setValue(val2); 
      sheet.getRange(row + 2, col).setValue(val3); 
      sheet.getRange(row + 3, col).setValue(val4); 
    } else {
      var color = params.color;
      var cell = sheet.getRange(row, col);
      if (color === 'clear') { cell.setBackground(null); cell.setFontLine('none'); } 
      else if (color === 'cancel') { cell.setBackground('#ef4444'); cell.setFontLine('line-through'); } 
      else { cell.setBackground(color); cell.setFontLine('none'); }
    }

    // ล้าง Cache ทันทีที่มีการแก้ไข
    var cache = CacheService.getScriptCache();
    cache.remove("queue_data_" + targetDate); 
    cache.remove("queue_data_today"); 

    return responseJSON({status: 'success', message: 'Saved'});
  } catch (err) { return responseJSON({status: 'error', message: err.toString()}); }
}

function responseJSON(obj) {
  return ContentService.createTextOutput(JSON.stringify(obj)).setMimeType(ContentService.MimeType.JSON);
}

function getAppointmentData(requestDate) {
  try { var ss = SpreadsheetApp.openByUrl(SHEET_URL); } 
  catch (err) { return { status: "error", message: "เข้าถึงไฟล์ไม่ได้" }; }
  
  var now = new Date();
  var sheetName = "";
  
  if (requestDate === "today") {
      // Format d/M ให้ตรงกับชื่อ Tab
      sheetName = Utilities.formatDate(now, "GMT+7", "d/M");
  } else {
      sheetName = requestDate;
  }
  
  var sheet = ss.getSheetByName(sheetName);
  if (!sheet) return { status: "error", message: "ไม่พบตารางเวรวันที่ " + sheetName, targetDate: sheetName };

  // เวลาปัจจุบัน (สำหรับ Auto-Hide 1 ชม.)
  var curH = parseInt(Utilities.formatDate(now, "GMT+7", "HH"));
  var curM = parseInt(Utilities.formatDate(now, "GMT+7", "mm"));
  var currentTimeVal = curH + (curM / 60.0);

  var startRow = 5; var startCol = 3;      
  var lastRow = sheet.getLastRow(); var lastCol = sheet.getLastColumn();
  
  var range = sheet.getRange(startRow, 1, lastRow - startRow + 1, lastCol);
  var rangeValues = range.getValues();
  var rangeBackgrounds = range.getBackgrounds();
  
  var allStaffNames = sheet.getRange(3, startCol, 1, lastCol - startCol + 1).getValues()[0]; 
  var targetIndices = [];
  var ttmPattern = /^[\u0E00-\u0E7F].*[a-zA-Z]+$/; 

  for(var k=0; k<allStaffNames.length; k++) {
    var name = allStaffNames[k].toString().trim();
    if (!name) continue;
    var nameLower = name.toLowerCase();
    if (nameLower.includes("หมอพร้อม") || nameLower.includes("งด") || nameLower.includes("pcc") || nameLower.includes("ศูนย์บริการ") || nameLower.includes("สำรอง")) continue; 
    if (name.includes("พจ.")) targetIndices.push({ index: k, type: 'TCM' }); 
    else if (ttmPattern.test(name)) targetIndices.push({ index: k, type: 'TTM' });
  }

  var appointments = [];
  var currentTimeSlot = "";

  for (var i = 0; i < rangeValues.length; i++) {
    var timeVal = rangeValues[i][0];
    if (timeVal && timeVal.toString().trim() !== "") currentTimeSlot = mapTime(timeVal);
    if (!currentTimeSlot) continue;

    // Logic 1-Hour Auto Hide
    var slotParts = currentTimeSlot.split(":"); 
    var slotTimeVal = parseInt(slotParts[0]) + (parseInt(slotParts[1]) / 60.0);
    // เฉพาะถ้าดูวันนี้ และเวลาผ่านไปแล้ว 1 ชม.
    if (requestDate === "today" && currentTimeVal > (slotTimeVal + 1.0)) continue; 

    if (timeVal && i + 3 < rangeValues.length) {
      for (var x = 0; x < targetIndices.length; x++) {
        var obj = targetIndices[x];
        var j = obj.index; var deptType = obj.type;
        if (deptType === 'TCM' && (currentTimeSlot === '17:00' || currentTimeSlot === '18:00')) continue;

        var staffName = allStaffNames[j];
        var colIndex = j + (startCol - 1); 
        var val1 = rangeValues[i][colIndex]; var val2 = rangeValues[i+1][colIndex]; 
        var val3 = rangeValues[i+2][colIndex]; var val4 = rangeValues[i+3][colIndex]; 
        
        var strVal3 = val3 ? val3.toString().trim() : "";
        if (strVal3.includes("ศูนย์บริการสาสุข ท.") || strVal3.includes("PCC สะเดา")) continue; 
        var checkText = (val2 + " " + val3 + " " + val4).toString();
        if (checkText.includes("ลา") || checkText.includes("ปิดเตียง")) continue;

        var activePatient = null;
        if (val1 && val1.toString().trim() !== "-" && val1.toString().trim() !== "ว่าง" && val1.toString().trim() !== "0" && val1.toString().trim() !== "") activePatient = val1.toString().trim();

        var roomNo = ""; var roomRegex = /(401[0-5])/; 
        if (roomRegex.test(val3)) roomNo = val3.toString().match(roomRegex)[0];
        else if (roomRegex.test(val4)) roomNo = val4.toString().match(roomRegex)[0];

        var txt3 = strVal3.replace(roomNo, "").trim(); var txt4 = val4 ? val4.toString().replace(roomNo, "").trim() : "";
        var status = "available"; var finalPatientName = "ว่าง";
        if (activePatient) { status = "busy"; finalPatientName = activePatient; } else { if (txt4 !== "") { status = "cancelled"; finalPatientName = txt4; } }
        var nameCellColor = rangeBackgrounds[i][colIndex]; 
        
        appointments.push({
          id: i + "_" + j, sheetDate: sheetName, sheetRow: startRow + i, sheetCol: colIndex, realColIndex: colIndex, 
          time: currentTimeSlot, staff: staffName, dept: deptType, patient: finalPatientName,
          rawVal1: val1 ? val1.toString() : "", rawVal2: val2 ? val2.toString() : "", rawVal3: val3 ? val3.toString() : "", rawVal4: val4 ? val4.toString() : "",
          tel: val2 ? val2.toString() : "", treatment: txt3, remarks: txt4, room: roomNo, status: status, bgColor: nameCellColor
        });
      }
    }
  }
  appointments.sort(function(a, b) { return a.time.localeCompare(b.time); });
  return { status: "success", date: sheetName, count: appointments.length, data: appointments };
}

function mapTime(input) {
  var str = input.toString().trim();
  if (input instanceof Date) { var h = input.getHours(); var m = input.getMinutes(); return (h < 10 ? "0" + h : h) + ":" + (m < 10 ? "0" + m : m); }
  switch(str) { case "1": return "08:30"; case "2": return "09:30"; case "3": return "10:30"; case "4": return "13:00"; case "5": return "14:00"; case "6": return "15:00"; case "7": return "17:00"; case "8": return "18:00"; default: return str; }
}
