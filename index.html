<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sadao Queue V9 (Status Color)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&family=Rajdhani:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
            min-height: 100vh;
        }

        /* Time Header */
        .time-header {
            font-family: 'Rajdhani', sans-serif;
            background: linear-gradient(90deg, #1e293b 0%, #0f172a 100%);
            border-left: 5px solid #06b6d4;
            color: #e2e8f0;
            padding: 8px 16px;
            font-size: 1.5rem;
            font-weight: 700;
            border-radius: 6px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* --- Queue Card Base --- */
        .queue-card {
            border-radius: 12px;
            padding: 14px;
            position: relative;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 140px; /* สูงพอให้เห็นรายละเอียด */
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* --- Status Themes (ตามภาพที่ส่งมา) --- */
        
        /* 1. ปกติ (Normal) */
        .theme-normal { background: #1e293b; color: #f1f5f9; border-left: 6px solid #64748b; }

        /* 2. ว่าง (Free) - เขียวอ่อนโปร่งแสง */
        .theme-free { 
            background: rgba(20, 83, 45, 0.3); 
            border: 1px solid #22c55e; 
            border-left: 6px solid #22c55e;
            color: #dcfce7;
        }

        /* 3. คนไข้มาแล้ว (Arrived) - สีเขียวสว่าง (ตัวหนังสือดำ) */
        .theme-arrived {
            background: #4ade80; /* Green 400 */
            color: #064e3b;      /* Green 900 Text */
            border: none;
            box-shadow: 0 0 15px rgba(74, 222, 128, 0.4);
        }

        /* 4. โทรแจ้งแล้ว (Contacted) - สีชมพูบานเย็น (ตัวหนังสือดำ) */
        .theme-contacted {
            background: #e879f9; /* Fuchsia 400 */
            color: #701a75;      /* Fuchsia 900 Text */
            border: none;
        }

        /* 5. ติดต่อไม่ได้ (Unreachable) - สีเหลือง (ตัวหนังสือดำ) */
        .theme-unreachable {
            background: #facc15; /* Yellow 400 */
            color: #451a03;      /* Yellow 950 Text */
            border: none;
        }

        /* 6. ผิดนัด (Missed) - สีเทาเข้ม */
        .theme-missed {
            background: #475569; /* Slate 600 */
            color: #cbd5e1;
            border-left: 6px solid #94a3b8;
        }

        /* ชื่อผู้ช่วย */
        .staff-name {
            font-size: 1.6rem;
            font-weight: 700;
            margin-bottom: 6px;
            line-height: 1.1;
        }

        /* ป้ายต่างๆ */
        .badge-base {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.9rem;
            font-weight: 600;
            display: inline-block;
            margin-top: 4px;
        }

        /* ป้ายแยกประเภท (ใช้เฉพาะตอนเป็นการ์ดปกติ) */
        .badge-blue { background: #172554; color: #93c5fd; border: 1px solid #3b82f6; } /* นวดส่งเสริม */
        .badge-cyan { background: #083344; color: #67e8f9; border: 1px solid #06b6d4; } /* นวดรักษา */
        
        /* ป้ายเลขห้อง */
        .room-tag {
            font-family: 'Rajdhani', sans-serif;
            background: #422006; color: #facc15;
            border: 1px solid #ca8a04;
            padding: 2px 8px; border-radius: 4px;
            font-size: 1rem; font-weight: 700;
        }
        
        /* ปรับสีป้ายเลขห้อง กรณีอยู่บนพื้นหลังสีสว่าง */
        .theme-arrived .room-tag, .theme-unreachable .room-tag, .theme-contacted .room-tag {
            background: rgba(255,255,255,0.8);
            color: #000;
            border: 1px solid rgba(0,0,0,0.2);
        }

        /* Animation */
        .spin-slow { animation: spin 2s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="pb-24">

    <header class="bg-slate-900/90 backdrop-blur border-b border-slate-700 sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center max-w-5xl">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded bg-cyan-800 flex items-center justify-center text-white">
                    <i class="fas fa-notes-medical"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-white">คิวงานแพทย์แผนไทย</h1>
                    <div class="text-xs text-slate-400 font-mono" id="lastUpdate">Connecting...</div>
                </div>
            </div>
            <button onclick="fetchData(false)" class="w-10 h-10 rounded-full bg-slate-800 text-cyan-400 border border-slate-600 hover:bg-slate-700 flex items-center justify-center">
                <i class="fas fa-sync-alt" id="refreshIcon"></i>
            </button>
        </div>
    </header>

    <div class="container mx-auto px-4 mt-6 max-w-5xl">
        <select id="staffFilter" onchange="filterData()" class="w-full p-3 bg-slate-800 text-white border border-slate-600 rounded-lg text-lg focus:outline-none focus:border-cyan-500 cursor-pointer">
            <option value="all">แสดงคิวของทุกคน (Show All)</option>
        </select>
    </div>

    <div id="contentArea" class="container mx-auto px-4 mt-6 max-w-5xl space-y-8"></div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbzGmp_5CoVDXRugHW8DOFHes4QI9p-Ho5J5th6hjrCd3U-fTFSkW9X84gRN_xo8au3UQg/exec";

        let allData = [];

        document.addEventListener('DOMContentLoaded', () => {
            fetchData(false);
            setInterval(() => fetchData(true), 30000); 
        });

        async function fetchData(isBackground) {
            const refreshIcon = document.getElementById('refreshIcon');
            if(!isBackground) refreshIcon.classList.add('spin-slow');

            try {
                const res = await fetch(API_URL + "?t=" + new Date().getTime());
                const json = await res.json();
                
                if(json.status === 'success') {
                    allData = json.data;
                    const now = new Date();
                    document.getElementById('lastUpdate').innerText = `Updated: ${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}`;
                    setupFilter(allData);
                    renderTimeline(allData);
                }
            } catch(e) { console.error(e); } 
            finally { refreshIcon.classList.remove('spin-slow'); }
        }

        function setupFilter(data) {
            const select = document.getElementById('staffFilter');
            const current = select.value;
            const staffSet = new Set(data.map(d => d.staff));
            while (select.options.length > 1) select.remove(1);
            Array.from(staffSet).sort().forEach(s => {
                const opt = document.createElement('option');
                opt.value = s; opt.text = `คิวของ: ${s}`; select.add(opt);
            });
            select.value = current;
        }

        function filterData() {
            const who = document.getElementById('staffFilter').value;
            if(who === 'all') renderTimeline(allData);
            else renderTimeline(allData.filter(d => d.staff === who));
        }

        function isJobFinished(timeStr) {
            const now = new Date();
            const [hours, minutes] = timeStr.split(':').map(Number);
            const jobTime = new Date(); jobTime.setHours(hours, minutes, 0, 0);
            return now > new Date(jobTime.getTime() + (60 * 60 * 1000));
        }

        function renderTimeline(data) {
            const container = document.getElementById('contentArea');
            container.innerHTML = '';
            
            // เปิดใช้บรรทัดล่างเพื่อซ่อนคิวเก่า
            const activeData = data.filter(d => !isJobFinished(d.time)); 
            // const activeData = data; 

            if(activeData.length === 0) {
                container.innerHTML = `<div class="text-center text-slate-500 py-10">ไม่พบคิวงานในขณะนี้</div>`;
                return;
            }

            const groups = activeData.reduce((acc, item) => {
                if(!acc[item.time]) acc[item.time] = [];
                acc[item.time].push(item); return acc;
            }, {});

            Object.keys(groups).sort().forEach(time => {
                const items = groups[time];
                
                let html = `
                    <div class="fade-in">
                        <div class="time-header"><i class="far fa-clock"></i> ${time} น.</div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                `;

                items.forEach(item => {
                    const txt = (item.treatment || '') + " " + (item.patient || '');
                    let themeClass = 'theme-normal';
                    let patientName = item.patient;
                    let descHtml = '';

                    // --- Logic ตรวจสอบ Keyword เพื่อเปลี่ยนสีการ์ด ---
                    
                    if (item.status === 'available') {
                        themeClass = 'theme-free';
                        patientName = `<span class="font-bold"><i class="fas fa-check"></i> ว่าง</span>`;
                        descHtml = `<div class="opacity-75">พร้อมรับงาน</div>`;
                    
                    } else if (item.status === 'cancelled' || item.cancelled || txt.includes('ผิดนัด')) {
                        themeClass = 'theme-missed';
                        patientName = `<span class="line-through opacity-75">${item.patient}</span>`;
                        descHtml = `<div class="font-bold text-slate-300">ผิดนัด / ยกเลิก</div>`;
                    
                    } else if (txt.includes('มาแล้ว') || txt.includes('คนไข้มา')) {
                        themeClass = 'theme-arrived'; // สีเขียว
                        descHtml = `<div class="font-bold"><i class="fas fa-user-check"></i> คนไข้มาแล้ว</div>`;
                    
                    } else if (txt.includes('โทรแจ้ง')) {
                        themeClass = 'theme-contacted'; // สีชมพู
                        descHtml = `<div class="font-bold"><i class="fas fa-phone-volume"></i> โทรแจ้งแล้ว</div>`;
                    
                    } else if (txt.includes('ติดต่อไม่ได้')) {
                        themeClass = 'theme-unreachable'; // สีเหลือง
                        descHtml = `<div class="font-bold"><i class="fas fa-exclamation-triangle"></i> ติดต่อไม่ได้</div>`;
                    
                    } else {
                        // --- กรณีปกติ (ไม่เข้าเงื่อนไขสถานะพิเศษ) ---
                        // เช็คประเภทนวดเพื่อใส่ป้ายสี (Badge)
                        let badge = '';
                        if (txt.includes('นวดส่งเสริม')) badge = `<span class="badge-base badge-blue">นวดส่งเสริม</span>`;
                        else if (txt.includes('นวดรักษา')) badge = `<span class="badge-base badge-cyan">นวดรักษา</span>`;
                        else badge = `<span class="text-slate-400">${item.treatment.replace('จอง','').trim()}</span>`;
                        
                        // เช็คจอง
                        if (txt.includes('จอง')) badge = `<span class="text-orange-400 font-bold border border-orange-400 rounded px-1 mr-1">จอง</span>` + badge;
                        
                        descHtml = `<div>${badge}</div>`;
                    }

                    // ปุ่มโทร (ปรับสีตาม Theme)
                    const telBtn = (item.tel && item.status !== 'available') 
                        ? `<a href="tel:${item.tel}" class="w-9 h-9 rounded-full bg-white/20 hover:bg-white/40 flex items-center justify-center transition shadow"><i class="fas fa-phone"></i></a>` 
                        : '';

                    // เลขห้อง
                    const roomBadge = item.room 
                        ? `<div class="mt-2 text-right"><span class="room-tag">${item.room}</span></div>` 
                        : '';

                    html += `
                        <div class="queue-card ${themeClass}">
                            <div class="staff-name flex justify-between items-start">
                                <span>${item.staff}</span>
                                ${telBtn}
                            </div>
                            
                            <div class="mt-2">
                                <div class="text-xl font-medium leading-tight mb-2">${patientName}</div>
                                ${descHtml}
                                ${roomBadge}
                            </div>
                        </div>
                    `;
                });

                html += `</div></div>`;
                container.innerHTML += html;
            });
        }
    </script>
</body>
</html>
