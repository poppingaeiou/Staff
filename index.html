<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sadao Hospital - คิวงานผู้ช่วยแพทย์แผนไทย</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Prompt', sans-serif; background-color: #f3f4f6; }
        .timeline-line { position: absolute; left: 18px; top: 0; bottom: 0; width: 2px; background: #e5e7eb; z-index: 0; }
        .time-dot { width: 40px; height: 40px; background: #0d9488; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.85rem; position: relative; z-index: 10; border: 4px solid #f3f4f6; }
        .card-shadow { box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    </style>
</head>
<body class="pb-20">

    <header class="bg-teal-700 text-white p-4 sticky top-0 z-50 shadow-lg">
        <div class="container mx-auto flex justify-between items-center max-w-3xl">
            <h1 class="text-lg font-bold"><i class="fas fa-spa"></i> คิวงานผู้ช่วยฯ</h1>
            <div class="text-right">
                <p id="dateDisplay" class="text-xs text-teal-200">Loading...</p>
                <button onclick="fetchData()" class="text-white text-sm underline"><i class="fas fa-sync-alt"></i> รีเฟรช</button>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 mt-4 max-w-3xl">
        <select id="staffFilter" onchange="filterData()" class="w-full p-2 border rounded-lg text-sm bg-white">
            <option value="all">แสดงงานทั้งหมด (ทุกคน)</option>
        </select>
    </div>

    <div id="timelineContainer" class="container mx-auto px-4 mt-6 max-w-3xl relative">
        <div class="timeline-line"></div>
        <div id="contentArea"></div>
    </div>

    <script>
        // ⚠️ ใส่ URL ใหม่ที่ Deploy แล้วตรงนี้
        const API_URL = "https://script.google.com/macros/s/AKfycbzGmp_5CoVDXRugHW8DOFHes4QI9p-Ho5J5th6hjrCd3U-fTFSkW9X84gRN_xo8au3UQg/exec";

        let allData = [];
        let groupedData = {};

        document.addEventListener('DOMContentLoaded', fetchData);

        async function fetchData() {
            document.getElementById('contentArea').innerHTML = '<p class="pl-12 text-gray-400">กำลังโหลด...</p>';
            try {
                const res = await fetch(API_URL);
                const json = await res.json();
                if(json.status === 'success') {
                    allData = json.data;
                    document.getElementById('dateDisplay').innerText = `วันที่ ${json.date}`;
                    setupFilter(allData);
                    renderTimeline(allData);
                } else {
                    alert('Error: ' + json.message);
                }
            } catch(e) { alert('เชื่อมต่อไม่ได้'); }
        }

        function setupFilter(data) {
            const select = document.getElementById('staffFilter');
            const staffSet = new Set(data.map(d => d.staff));
            staffSet.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s;
                opt.text = `ดูงานของ: ${s}`;
                select.add(opt);
            });
        }

        function filterData() {
            const who = document.getElementById('staffFilter').value;
            if(who === 'all') renderTimeline(allData);
            else renderTimeline(allData.filter(d => d.staff === who));
        }

        function renderTimeline(data) {
            const container = document.getElementById('contentArea');
            container.innerHTML = '';

            // Group data by Time
            const groups = data.reduce((acc, item) => {
                if(!acc[item.time]) acc[item.time] = [];
                acc[item.time].push(item);
                return acc;
            }, {});

            // Sort times
            const times = Object.keys(groups).sort();

            times.forEach(time => {
                const items = groups[time];
                
                // HTML สำหรับ 1 ช่วงเวลา (Time Block)
                let html = `
                    <div class="flex items-start mb-8 relative">
                        <div class="flex-shrink-0 w-12 flex justify-center">
                            <div class="time-dot shadow-md">
                                ${time}
                            </div>
                        </div>
                        
                        <div class="flex-grow pl-4 space-y-3">
                `;

                items.forEach(item => {
                    const isCancel = item.status === 'cancelled_slot';
                    const bg = isCancel ? 'bg-gray-100 border-gray-300' : 'bg-white border-teal-500';
                    const badgeColor = item.room ? 'bg-purple-100 text-purple-700' : 'hidden';

                    html += `
                        <div class="${bg} border-l-4 p-3 rounded-lg card-shadow relative">
                            <div class="flex justify-between">
                                <span class="text-xs font-bold text-gray-500 bg-gray-100 px-2 py-0.5 rounded">${item.staff}</span>
                                <span class="${badgeColor} text-xs px-2 py-0.5 rounded font-bold">ห้อง ${item.room}</span>
                            </div>
                            <h3 class="font-bold text-gray-800 mt-1">${item.patient}</h3>
                            <p class="text-sm text-teal-600">${item.treatment || ''}</p>
                            ${item.cancelled ? `<p class="text-xs text-red-400 mt-1 border-t pt-1">ยกเลิก: <strike>${item.cancelled}</strike></p>` : ''}
                            ${item.tel && !isCancel ? `<a href="tel:${item.tel}" class="absolute bottom-2 right-2 text-green-500 bg-green-50 p-2 rounded-full"><i class="fas fa-phone"></i></a>` : ''}
                        </div>
                    `;
                });

                html += `</div></div>`; // ปิด div
                container.innerHTML += html;
            });

            if(data.length === 0) container.innerHTML = '<p class="pl-12 text-gray-400">ไม่มีคิวงาน</p>';
        }
    </script>
</body>
</html>
