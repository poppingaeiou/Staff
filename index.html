<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sadao Queue V15 (Simple Logic)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&family=Rajdhani:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #0f172a; color: #e2e8f0; min-height: 100vh; }

        .time-header {
            font-family: 'Rajdhani', sans-serif;
            background: linear-gradient(90deg, #1e293b 0%, #0f172a 100%);
            border-left: 4px solid #06b6d4;
            color: #e2e8f0; padding: 6px 14px; font-size: 1.25rem; font-weight: 700;
            border-radius: 6px; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;
        }

        .queue-card {
            border-radius: 10px; padding: 10px 12px; position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: all 0.2s ease;
            display: flex; flex-direction: column; height: 100%; 
            border: 1px solid rgba(255,255,255,0.05);
        }

        /* ล็อคความสูงกล่องชื่อ */
        .patient-name-container {
            height: 50px; display: flex; align-items: center; margin-top: 4px; margin-bottom: 4px;
        }

        .theme-normal { background: #1e293b; color: #f1f5f9; border-left: 4px solid #64748b; }
        .theme-free { background: rgba(20, 83, 45, 0.2); border: 1px solid #22c55e; border-left: 4px solid #22c55e; color: #dcfce7; }
        .theme-cancel { background: #334155; color: #94a3b8; border-left: 4px solid #64748b; }

        .theme-sheet-green { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: #fff; border: none; box-shadow: 0 4px 6px rgba(22, 163, 74, 0.3); }
        .theme-sheet-pink { background: linear-gradient(135deg, #e879f9 0%, #c026d3 100%); color: #fff; border: none; }
        .theme-sheet-yellow { background: linear-gradient(135deg, #facc15 0%, #ca8a04 100%); color: #422006; border: none; }

        .staff-name { font-size: 1.25rem; font-weight: 700; line-height: 1.1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .patient-text { font-size: 1.1rem; font-weight: 600; line-height: 1.2; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        .badge-base { padding: 1px 6px; border-radius: 4px; font-size: 0.8rem; font-weight: 600; display: inline-block; }
        .theme-normal .badge-blue { background: #172554; color: #93c5fd; border: 1px solid #3b82f6; } 
        .theme-normal .badge-cyan { background: #083344; color: #67e8f9; border: 1px solid #06b6d4; }
        .theme-normal .text-desc { color: #cbd5e1; font-size: 0.85rem; }

        .badge-on-color { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: #fff; }
        .theme-sheet-yellow .badge-on-color { color: #422006; border-color: rgba(0,0,0,0.1); background: rgba(255,255,255,0.4); }
        
        .badge-booking { font-weight: 800; border: 1px solid #fb923c; padding: 0px 4px; border-radius: 3px; margin-right: 4px; color: #fb923c; font-size: 0.75rem; vertical-align: middle; }
        .theme-sheet-green .badge-booking, .theme-sheet-pink .badge-booking { color: #fff; border-color: #fff; background: rgba(255,255,255,0.2); }
        .theme-sheet-yellow .badge-booking { color: #713f12; border-color: #713f12; background: rgba(255,255,255,0.3); }

        .room-tag { font-family: 'Rajdhani', sans-serif; background: #422006; color: #facc15; border: 1px solid #ca8a04; padding: 1px 6px; border-radius: 4px; font-size: 0.9rem; font-weight: 700; }
        .theme-sheet-green .room-tag, .theme-sheet-pink .room-tag { background: rgba(0,0,0,0.5); color: #fff; border: none; }
        .theme-sheet-yellow .room-tag { background: rgba(0,0,0,0.6); color: #fff; border: none; }

        .spin-slow { animation: spin 2s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="pb-20">
    <header class="bg-slate-900/95 backdrop-blur border-b border-slate-700 sticky top-0 z-50">
        <div class="container mx-auto px-4 py-2 flex justify-between items-center max-w-5xl">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded bg-cyan-800 flex items-center justify-center text-white"><i class="fas fa-notes-medical text-sm"></i></div>
                <div>
                    <h1 class="text-lg font-bold text-white">คิวงานแพทย์แผนไทย</h1>
                    <div class="text-[10px] text-slate-400 font-mono" id="lastUpdate">Connecting...</div>
                </div>
            </div>
            <button onclick="fetchData(false)" class="w-8 h-8 rounded-full bg-slate-800 text-cyan-400 border border-slate-600 hover:bg-slate-700 flex items-center justify-center"><i class="fas fa-sync-alt text-xs" id="refreshIcon"></i></button>
        </div>
    </header>

    <div class="container mx-auto px-4 mt-4 max-w-5xl">
        <select id="staffFilter" onchange="filterData()" class="w-full p-2 bg-slate-800 text-white border border-slate-600 rounded text-base focus:outline-none focus:border-cyan-500 cursor-pointer">
            <option value="all">แสดงคิวของทุกคน (Show All)</option>
        </select>
    </div>

    <div id="contentArea" class="container mx-auto px-4 mt-4 max-w-5xl space-y-6"></div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbzGmp_5CoVDXRugHW8DOFHes4QI9p-Ho5J5th6hjrCd3U-fTFSkW9X84gRN_xo8au3UQg/exec";
        let allData = [];

        document.addEventListener('DOMContentLoaded', () => {
            fetchData(false);
            setInterval(() => fetchData(true), 30000); 
        });

        async function fetchData(isBackground) {
            const refreshIcon = document.getElementById('refreshIcon');
            if(!isBackground) refreshIcon.classList.add('spin-slow');
            try {
                const res = await fetch(API_URL + "?t=" + new Date().getTime());
                const json = await res.json();
                if(json.status === 'success') {
                    allData = json.data;
                    const now = new Date();
                    document.getElementById('lastUpdate').innerText = `Updated: ${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}`;
                    setupFilter(allData);
                    renderTimeline(allData);
                }
            } catch(e) { console.error(e); } 
            finally { refreshIcon.classList.remove('spin-slow'); }
        }

        function setupFilter(data) {
            const select = document.getElementById('staffFilter');
            const current = select.value;
            const staffSet = new Set(data.map(d => d.staff));
            while (select.options.length > 1) select.remove(1);
            Array.from(staffSet).sort().forEach(s => {
                const opt = document.createElement('option');
                opt.value = s; opt.text = `คิวของ: ${s}`; select.add(opt);
            });
            select.value = current;
        }

        function filterData() {
            const who = document.getElementById('staffFilter').value;
            if(who === 'all') renderTimeline(allData);
            else renderTimeline(allData.filter(d => d.staff === who));
        }

        function isJobFinished(timeStr) {
            const now = new Date();
            const [hours, minutes] = timeStr.split(':').map(Number);
            const jobTime = new Date(); jobTime.setHours(hours, minutes, 0, 0);
            return now > new Date(jobTime.getTime() + (60 * 60 * 1000));
        }

        function renderTimeline(data) {
            const container = document.getElementById('contentArea');
            container.innerHTML = '';
            
            const activeData = data.filter(d => !isJobFinished(d.time)); 

            if(activeData.length === 0) {
                container.innerHTML = `<div class="text-center text-slate-500 py-10 text-sm">ไม่พบคิวงานในขณะนี้</div>`;
                return;
            }

            const groups = activeData.reduce((acc, item) => {
                if(!acc[item.time]) acc[item.time] = [];
                acc[item.time].push(item); return acc;
            }, {});

            Object.keys(groups).sort().forEach(time => {
                const items = groups[time];
                
                let html = `
                    <div class="fade-in">
                        <div class="time-header"><i class="far fa-clock"></i> ${time} น.</div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 items-stretch">
                `;

                items.forEach(item => {
                    let themeClass = 'theme-normal';
                    let patientName = item.patient;
                    let descHtml = '';
                    
                    const bg = (item.bgColor || "").toLowerCase();
                    const isSheetColor = (bg === '#00ff00' || bg === '#lime' || bg === '#ff00ff' || bg === '#magenta' || bg === '#ffff00' || bg === '#yellow');

                    if (bg === '#00ff00' || bg === '#lime') themeClass = 'theme-sheet-green';
                    else if (bg === '#ff00ff' || bg === '#magenta' || bg === '#ea4335') themeClass = 'theme-sheet-pink';
                    else if (bg === '#ffff00' || bg === '#yellow') themeClass = 'theme-sheet-yellow';

                    if (item.status === 'available') {
                        if(themeClass === 'theme-normal') themeClass = 'theme-free'; 
                        patientName = `<span class="text-emerald-400"><i class="fas fa-check"></i> ว่าง</span>`;
                        descHtml = `<div class="opacity-60 text-xs">พร้อมรับงาน</div>`;
                    
                    } else if (item.status === 'cancelled') {
                        themeClass = 'theme-cancel';
                        // ⚠️ Logic นี้จะโชว์ทั้ง ชื่อคน หรือ หมายเหตุ (เช่น "รถเสีย")
                        patientName = `<span class="line-through opacity-50">${item.patient}</span>`;
                        descHtml = `<div class="font-bold text-slate-400 text-xs">ยกเลิก/หมายเหตุ</div>`;
                    } else {
                        let txt = item.treatment || '';
                        let badge = '';
                        const badgeStyle = isSheetColor ? 'badge-base badge-on-color' : 'badge-base';
                        const blueStyle = isSheetColor ? 'badge-base badge-on-color' : 'badge-base badge-blue';
                        const cyanStyle = isSheetColor ? 'badge-base badge-on-color' : 'badge-base badge-cyan';

                        if (txt.includes('นวดส่งเสริม')) badge = `<span class="${blueStyle}">นวดส่งเสริม</span>`;
                        else if (txt.includes('นวดรักษา')) badge = `<span class="${cyanStyle}">นวดรักษา</span>`;
                        else badge = `<span class="text-desc ${isSheetColor ? 'text-white/80' : ''}">${txt.replace('จอง','').trim()}</span>`;
                        
                        if (txt.includes('จอง')) badge = `<span class="badge-booking">จอง</span>` + badge;
                        descHtml = `<div>${badge || '&nbsp;'}</div>`;
                    }

                    const telBtn = (item.tel && item.status !== 'available' && item.status !== 'cancelled') 
                        ? `<a href="tel:${item.tel}" class="w-7 h-7 rounded-full bg-white/20 hover:bg-white/40 flex items-center justify-center transition text-white"><i class="fas fa-phone text-xs"></i></a>` 
                        : '';

                    const roomBadge = item.room 
                        ? `<div class="text-right"><span class="room-tag">${item.room}</span></div>` 
                        : `<div class="h-5"></div>`; 

                    html += `
                        <div class="h-full">
                            <div class="queue-card ${themeClass}">
                                <div class="staff-name flex justify-between items-start">
                                    <span class="truncate pr-2">${item.staff}</span>
                                    ${telBtn}
                                </div>
                                <div class="flex-grow flex flex-col justify-between">
                                    <div class="patient-name-container">
                                        <div class="patient-text w-full">${patientName}</div>
                                    </div>
                                    <div class="mt-1 space-y-1">
                                        ${descHtml}
                                        ${roomBadge}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += `</div></div>`;
                container.innerHTML += html;
            });
        }
    </script>
</body>
</html>
