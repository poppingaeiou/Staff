<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sadao Queue V11 (Final Color & Content)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&family=Rajdhani:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
            min-height: 100vh;
        }

        .time-header {
            font-family: 'Rajdhani', sans-serif;
            background: linear-gradient(90deg, #1e293b 0%, #0f172a 100%);
            border-left: 5px solid #06b6d4;
            color: #e2e8f0;
            padding: 8px 16px;
            font-size: 1.5rem;
            font-weight: 700;
            border-radius: 6px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Card Structure */
        .queue-card {
            border-radius: 12px;
            padding: 14px;
            position: relative;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 140px; 
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* --- THEMES (Background Colors) --- */
        
        /* Default Dark Theme */
        .theme-normal { background: #1e293b; color: #f1f5f9; border-left: 6px solid #64748b; }
        
        /* Free Slot */
        .theme-free { background: rgba(20, 83, 45, 0.3); border: 1px solid #22c55e; border-left: 6px solid #22c55e; color: #dcfce7; }
        
        /* Cancelled */
        .theme-cancel { background: #475569; color: #cbd5e1; border-left: 6px solid #94a3b8; }

        /* --- SHEET COLORS (สีสด) --- */
        /* ข้อความต้องเป็นสีเข้ม (Dark Text) เพื่อให้อ่านออกบนพื้นสีสว่าง */
        
        /* สีเขียว (คนไข้มาแล้ว) */
        .theme-sheet-green {
            background: linear-gradient(135deg, #00ff00 0%, #4ade80 100%);
            color: #064e3b; 
            border: none;
            box-shadow: 0 0 15px rgba(74, 222, 128, 0.6);
        }

        /* สีชมพู (โทรแจ้งแล้ว) */
        .theme-sheet-pink {
            background: linear-gradient(135deg, #ff00ff 0%, #e879f9 100%);
            color: #701a75;
            border: none;
        }

        /* สีเหลือง (ติดต่อไม่ได้) */
        .theme-sheet-yellow {
            background: linear-gradient(135deg, #ffff00 0%, #facc15 100%);
            color: #451a03;
            border: none;
        }

        /* Staff Name */
        .staff-name {
            font-size: 1.6rem;
            font-weight: 700;
            margin-bottom: 6px;
            line-height: 1.1;
        }

        /* --- BADGES (ป้ายรายละเอียด) --- */
        .badge-base { padding: 2px 8px; border-radius: 4px; font-size: 0.9rem; font-weight: 600; display: inline-block; margin-top: 4px; }
        
        /* Badge บนพื้นมืด (ปกติ) */
        .theme-normal .badge-blue { background: #172554; color: #93c5fd; border: 1px solid #3b82f6; } 
        .theme-normal .badge-cyan { background: #083344; color: #67e8f9; border: 1px solid #06b6d4; }
        .theme-normal .text-desc { color: #cbd5e1; }

        /* Badge บนพื้นสีสด (ต้องปรับให้จางลงเพื่อให้เข้ากับพื้นหลัง) */
        .theme-sheet-green .badge-base, 
        .theme-sheet-pink .badge-base, 
        .theme-sheet-yellow .badge-base {
            background: rgba(255,255,255,0.5); /* พื้นหลังขาวจางๆ */
            border: 1px solid rgba(0,0,0,0.1);
            color: #000; /* ตัวหนังสือดำ */
        }
        
        /* Badge คำว่า "จอง" */
        .badge-booking {
            font-weight: 800;
            border: 1px solid #fb923c;
            padding: 1px 6px;
            border-radius: 4px;
            margin-right: 5px;
            color: #fb923c;
        }
        /* จอง บนพื้นสีสด ให้เปลี่ยนสีให้ชัดขึ้น */
        .theme-sheet-green .badge-booking, .theme-sheet-pink .badge-booking, .theme-sheet-yellow .badge-booking {
            color: #c2410c; /* สีส้มอิฐเข้ม */
            border-color: #c2410c;
            background: rgba(255,255,255,0.3);
        }

        /* Room Tag */
        .room-tag {
            font-family: 'Rajdhani', sans-serif;
            background: #422006; color: #facc15;
            border: 1px solid #ca8a04;
            padding: 2px 8px; border-radius: 4px;
            font-size: 1rem; font-weight: 700;
        }
        /* Room Tag บนพื้นสีสด */
        .theme-sheet-green .room-tag, .theme-sheet-pink .room-tag, .theme-sheet-yellow .room-tag {
            background: rgba(0,0,0,0.7); color: #fff; border: none;
        }

        .spin-slow { animation: spin 2s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="pb-24">

    <header class="bg-slate-900/90 backdrop-blur border-b border-slate-700 sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center max-w-5xl">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded bg-cyan-800 flex items-center justify-center text-white">
                    <i class="fas fa-notes-medical"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-white">คิวงานแพทย์แผนไทย</h1>
                    <div class="text-xs text-slate-400 font-mono" id="lastUpdate">Connecting...</div>
                </div>
            </div>
            <button onclick="fetchData(false)" class="w-10 h-10 rounded-full bg-slate-800 text-cyan-400 border border-slate-600 hover:bg-slate-700 flex items-center justify-center">
                <i class="fas fa-sync-alt" id="refreshIcon"></i>
            </button>
        </div>
    </header>

    <div class="container mx-auto px-4 mt-6 max-w-5xl">
        <select id="staffFilter" onchange="filterData()" class="w-full p-3 bg-slate-800 text-white border border-slate-600 rounded-lg text-lg focus:outline-none focus:border-cyan-500 cursor-pointer">
            <option value="all">แสดงคิวของทุกคน (Show All)</option>
        </select>
    </div>

    <div id="contentArea" class="container mx-auto px-4 mt-6 max-w-5xl space-y-8"></div>

    <script>
        // ⚠️ ใส่ URL Web App เดิมของคุณได้เลยครับ
        const API_URL = "https://script.google.com/macros/s/AKfycbzGmp_5CoVDXRugHW8DOFHes4QI9p-Ho5J5th6hjrCd3U-fTFSkW9X84gRN_xo8au3UQg/exec";

        let allData = [];

        document.addEventListener('DOMContentLoaded', () => {
            fetchData(false);
            setInterval(() => fetchData(true), 30000); 
        });

        async function fetchData(isBackground) {
            const refreshIcon = document.getElementById('refreshIcon');
            if(!isBackground) refreshIcon.classList.add('spin-slow');

            try {
                const res = await fetch(API_URL + "?t=" + new Date().getTime());
                const json = await res.json();
                
                if(json.status === 'success') {
                    allData = json.data;
                    const now = new Date();
                    document.getElementById('lastUpdate').innerText = `Updated: ${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}`;
                    setupFilter(allData);
                    renderTimeline(allData);
                }
            } catch(e) { console.error(e); } 
            finally { refreshIcon.classList.remove('spin-slow'); }
        }

        function setupFilter(data) {
            const select = document.getElementById('staffFilter');
            const current = select.value;
            const staffSet = new Set(data.map(d => d.staff));
            while (select.options.length > 1) select.remove(1);
            Array.from(staffSet).sort().forEach(s => {
                const opt = document.createElement('option');
                opt.value = s; opt.text = `คิวของ: ${s}`; select.add(opt);
            });
            select.value = current;
        }

        function filterData() {
            const who = document.getElementById('staffFilter').value;
            if(who === 'all') renderTimeline(allData);
            else renderTimeline(allData.filter(d => d.staff === who));
        }

        function isJobFinished(timeStr) {
            const now = new Date();
            const [hours, minutes] = timeStr.split(':').map(Number);
            const jobTime = new Date(); jobTime.setHours(hours, minutes, 0, 0);
            return now > new Date(jobTime.getTime() + (60 * 60 * 1000));
        }

        function renderTimeline(data) {
            const container = document.getElementById('contentArea');
            container.innerHTML = '';
            
            // กรองคิวที่จบไปแล้ว
            const activeData = data.filter(d => !isJobFinished(d.time)); 

            if(activeData.length === 0) {
                container.innerHTML = `<div class="text-center text-slate-500 py-10">ไม่พบคิวงานในขณะนี้</div>`;
                return;
            }

            const groups = activeData.reduce((acc, item) => {
                if(!acc[item.time]) acc[item.time] = [];
                acc[item.time].push(item); return acc;
            }, {});

            Object.keys(groups).sort().forEach(time => {
                const items = groups[time];
                
                let html = `
                    <div class="fade-in">
                        <div class="time-header"><i class="far fa-clock"></i> ${time} น.</div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                `;

                items.forEach(item => {
                    let themeClass = 'theme-normal';
                    let patientName = item.patient;
                    let descHtml = '';
                    
                    // --- 1. กำหนด Theme สีพื้นหลัง (Color Logic) ---
                    const bg = (item.bgColor || "").toLowerCase();

                    // เช็คสีจาก Sheet เพื่อเลือก Class พื้นหลัง
                    if (bg === '#00ff00' || bg === '#lime') {
                         themeClass = 'theme-sheet-green';
                    } else if (bg === '#ff00ff' || bg === '#magenta' || bg === '#ea4335') {
                         themeClass = 'theme-sheet-pink';
                    } else if (bg === '#ffff00' || bg === '#yellow') {
                         themeClass = 'theme-sheet-yellow';
                    }

                    // --- 2. กำหนดเนื้อหา (Content Logic) ---
                    // ถ้าว่าง หรือ ยกเลิก ให้แสดงเนื้อหาเฉพาะ
                    if (item.status === 'available') {
                        // ถ้าว่างจริง ให้ Override theme เป็น theme-free เสมอ (หรือจะให้ใช้สี Sheet ก็ได้ แต่ปกติว่างจะไม่มีสี)
                        if(themeClass === 'theme-normal') themeClass = 'theme-free'; 
                        
                        patientName = `<span class="font-bold"><i class="fas fa-check"></i> ว่าง</span>`;
                        descHtml = `<div class="opacity-75">พร้อมรับงาน</div>`;
                    
                    } else if (item.status === 'cancelled') {
                        themeClass = 'theme-cancel'; // ยกเลิกให้เป็นสีเทาเสมอ
                        patientName = `<span class="line-through opacity-75">${item.patient}</span>`;
                        descHtml = `<div class="font-bold text-slate-300">ยกเลิก/ผิดนัด</div>`;

                    } else {
                        // *** กรณีมีนัด (แสดงรายละเอียดการรักษาแบบ V.9) ***
                        // ไม่ว่าจะพื้นหลังสีอะไร ให้แสดงข้อความ treatment เหมือนเดิม
                        
                        let txt = item.treatment || '';
                        let badge = '';

                        // ใส่กรอบประเภทนวด
                        if (txt.includes('นวดส่งเสริม')) {
                            badge = `<span class="badge-base badge-blue">นวดส่งเสริม</span>`;
                        } else if (txt.includes('นวดรักษา')) {
                            badge = `<span class="badge-base badge-cyan">นวดรักษา</span>`;
                        } else {
                             // ข้อความทั่วไป (ตัดคำว่า จอง ออกก่อนเพราะจะไปแปะข้างหน้า)
                             badge = `<span class="text-desc">${txt.replace('จอง','').trim()}</span>`;
                        }
                        
                        // ใส่ป้าย "จอง" ถ้ามี
                        if (txt.includes('จอง')) {
                            badge = `<span class="badge-booking">จอง</span>` + badge;
                        }
                        
                        descHtml = `<div>${badge}</div>`;
                    }

                    // ปุ่มโทร
                    const telBtn = (item.tel && item.status !== 'available') 
                        ? `<a href="tel:${item.tel}" class="w-9 h-9 rounded-full bg-white/30 hover:bg-white/50 flex items-center justify-center transition shadow text-black"><i class="fas fa-phone"></i></a>` 
                        : '';

                    const roomBadge = item.room 
                        ? `<div class="mt-2 text-right"><span class="room-tag">${item.room}</span></div>` 
                        : '';

                    html += `
                        <div class="queue-card ${themeClass}">
                            <div class="staff-name flex justify-between items-start">
                                <span>${item.staff}</span>
                                ${telBtn}
                            </div>
                            
                            <div class="mt-2">
                                <div class="text-xl font-medium leading-tight mb-2">${patientName}</div>
                                ${descHtml}
                                ${roomBadge}
                            </div>
                        </div>
                    `;
                });

                html += `</div></div>`;
                container.innerHTML += html;
            });
        }
    </script>
</body>
</html>
